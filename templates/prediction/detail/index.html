{% extends 'base.html' %}
{% load static %}
{% load static_league %}

{% block content %}


<!-- ê·¸ë˜í”„ -->
<!-- Prediction ì•± ì „ìš© CSS -->
<link rel="stylesheet" href="{% static 'prediction/style.css' %}">

<div class="container my-4">

    <!-- ì œëª© -->
    <h2 class="mb-4">{{ schedule.team1 }} vs {{ schedule.team2 }} ìƒì„¸ ì˜ˆì¸¡ì •ë³´</h2>

    <!-- ì—°ë…¸ë‘ìƒ‰ ì—…ë°ì´íŠ¸ í˜„í™© ë°•ìŠ¤ -->
    <div class="alert alert-warning">
        ğŸ“Œ ì—…ë°ì´íŠ¸ í˜„í™©: 2025ë…„ {{ schedule.month }}ì›” {{ schedule.date }}ì¼ ì˜ˆì¸¡ ë°ì´í„° ì—…ë°ì´íŠ¸
    </div>

    <!-- ì—°ì´ˆë¡ìƒ‰ ìƒì„¸ ì •ë³´ ë°•ìŠ¤ -->
    <div class="alert alert-success">
        ğŸ“‹ <strong>ìƒì„¸ ì •ë³´</strong><br>
        ğŸ”¹ ë‚ ì§œ: {{ schedule.month }}/{{ schedule.date }}<br>
        ğŸ”¹ ê²½ê¸°ì¥: {{ schedule.stadium }}<br>
        ğŸ”¹ ìŠ¹ë¥  ì˜ˆì¸¡: {{ schedule.team1 }}({{ schedule.win_prob_team1 }}%) vs {{ schedule.team2 }}({{ schedule.win_prob_team2 }}%)<br>
    </div>

    <div class="row g-3 mb-3">
        <!-- ë¶„ë¥˜ ì„±ëŠ¥ì§€í‘œ -->
        <div class="col-12 col-lg-6">
            <div class="card h-100 border-info">
            <div class="card-header bg-info text-dark fw-bold">ë¶„ë¥˜ ì„±ëŠ¥ì§€í‘œ</div>
            <div class="card-body">
                <p class="mb-2 text-muted">
                ìµœì‹  ì˜ˆì¸¡ì— ì‚¬ìš©í•œ ë°ì´í„°ì™€ ìœ íš¨ì„±/í…ŒìŠ¤íŠ¸ ì„±ëŠ¥(í˜¼ë™í–‰ë ¬, ë¦¬í¬íŠ¸)ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
                <a class="btn btn-outline-info"
                href="{% url 'prediction:class_metrics' league date_str away|upper home|upper %}">
                ì‚¬ìš© ë°ì´í„°, í˜¼ë™í–‰ë ¬, ì„±ëŠ¥ì§€í‘œ ë³´ê¸° â†’
                </a>
            </div>
            </div>
        </div>

        <!-- íšŒê·€ ìƒì„¸ì§€í‘œ -->
        <div class="col-12 col-lg-6">
            <div class="card h-100 border-info">
            <div class="card-header bg-info text-dark fw-bold">íšŒê·€ ìƒì„¸ì§€í‘œ</div>
            <div class="card-body">
                <p class="mb-3 text-muted small">
                ì„ ë°œíˆ¬ìˆ˜(ì‹¤ì œ/ì˜ˆì¸¡), íˆ¬ìˆ˜ êµì²´ ë¡œê·¸, ê²Œì„ PK ë“± ì„¸ë¶€ ë¡œê·¸ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
                </p>
                <a class="btn btn-outline-info"
                href="{% url 'prediction:reg_metrics' league date_str away|upper home|upper %}">
                ì‚¬ìš© ë°ì´í„° / ìƒì„¸ ë¡œê·¸ ë³´ê¸° â†’
                </a>
            </div>
            </div>
        </div>
    </div>



    <!-- ê·¸ë˜í”„ ì„¹ì…˜ -->
    <div class="card mt-4">

        <!-- ë“ì  -->
        <div class="card-header bg-light">
            ğŸ“Š ë“ì  ì‹œë‚˜ë¦¬ì˜¤
        </div>

        <div class="card-body">
            <canvas id="scoreChart"></canvas>
        </div>

        <!-- ì´ ë“ì  -->
        <div class="card-header bg-light">
            ğŸ“Š ì´ ë“ì  ì‹œë‚˜ë¦¬ì˜¤
        </div>

        <div class="card-body">
            <canvas id="cumulativeChart"></canvas>
        </div>

    </div>
</div>


<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const inning_labels = ['1íšŒ','2íšŒ','3íšŒ','4íšŒ','5íšŒ','6íšŒ','7íšŒ','8íšŒ','9íšŒ'];

  // Django ì»¨í…ìŠ¤íŠ¸ì—ì„œ ê°€ì ¸ì˜¤ê¸°
  const predAway = {{ scenario_team1|safe }};   // away ì˜ˆì¸¡
  const predHome = {{ scenario_team2|safe }};   // home ì˜ˆì¸¡
  const actAway  = {{ actual_team1|safe }};     // away ì‹¤ì œ (ì—†ìœ¼ë©´ [])
  const actHome  = {{ actual_team2|safe }};     // home ì‹¤ì œ (ì—†ìœ¼ë©´ [])

  // ëˆ„ì  ìƒì„±(ì—†ëŠ” ë°ì´í„°ë©´ ë¹ˆ ë°°ì—´ë¡œ ë°˜í™˜)
  function cumulative(arr) {
    if (!Array.isArray(arr) || arr.length === 0) return [];
    const out = [];
    arr.reduce((acc, cur, idx) => {
      const v = (acc + (Number(cur) || 0));
      out.push(v);
      return v;
    }, 0);
    return out;
  }

  const cumPredAway = cumulative(predAway);
  const cumPredHome = cumulative(predHome);
  const cumActAway  = cumulative(actAway);
  const cumActHome  = cumulative(actHome);

  // ì‹¤ì œ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¼ì¸ ìˆ¨ê¹€
  const hideActAway = (actAway.length === 0);
  const hideActHome = (actHome.length === 0);
  const hideCumActAway = (cumActAway.length === 0);
  const hideCumActHome = (cumActHome.length === 0);

  // âœ” ë“ì  ì‹œë‚˜ë¦¬ì˜¤(ì´ë‹ë³„) â€” 4ê°œ ì„ 
  const scoreCtx = document.getElementById('scoreChart').getContext('2d');
  new Chart(scoreCtx, {
    type: 'line',
    data: {
      labels: inning_labels,
      datasets: [
        {
          label: '{{ away }} (ì˜ˆì¸¡)',
          data: predAway,
          borderWidth: 2,
          backgroundColor: 'rgba(255, 99, 132, 0.15)',
          borderColor: 'rgba(255, 99, 132, 1)',
          pointRadius: 2,
        },
        {
          label: '{{ home }} (ì˜ˆì¸¡)',
          data: predHome,
          borderWidth: 2,
          backgroundColor: 'rgba(54, 162, 235, 0.15)',
          borderColor: 'rgba(54, 162, 235, 1)',
          pointRadius: 2,
        },
        {
          label: '{{ away }} (ì‹¤ì œ)',
          data: actAway,
          borderWidth: 2,
          borderDash: [6,4],
          backgroundColor: 'rgba(255, 99, 132, 0.05)',
          borderColor: 'rgba(255, 99, 132, 0.7)',
          pointRadius: 2,
          hidden: hideActAway,
        },
        {
          label: '{{ home }} (ì‹¤ì œ)',
          data: actHome,
          borderWidth: 2,
          borderDash: [6,4],
          backgroundColor: 'rgba(54, 162, 235, 0.05)',
          borderColor: 'rgba(54, 162, 235, 0.7)',
          pointRadius: 2,
          hidden: hideActHome,
        },
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'nearest', intersect: false },
      scales: {
        y: { beginAtZero: true, ticks: { stepSize: 1 } }
      }
    }
  });

  // âœ” ì´ ë“ì (ëˆ„ì ) â€” 4ê°œ ì„ 
  const cumulativeCtx = document.getElementById('cumulativeChart').getContext('2d');
  new Chart(cumulativeCtx, {
    type: 'line',
    data: {
      labels: inning_labels,
      datasets: [
        {
          label: '{{ away }} ì´ ë“ì  (ì˜ˆì¸¡)',
          data: cumPredAway,
          borderWidth: 2,
          backgroundColor: 'rgba(255, 206, 86, 0.15)',
          borderColor: 'rgba(255, 206, 86, 1)',
          pointRadius: 2,
        },
        {
          label: '{{ home }} ì´ ë“ì  (ì˜ˆì¸¡)',
          data: cumPredHome,
          borderWidth: 2,
          backgroundColor: 'rgba(75, 192, 192, 0.15)',
          borderColor: 'rgba(75, 192, 192, 1)',
          pointRadius: 2,
        },
        {
          label: '{{ away }} ì´ ë“ì  (ì‹¤ì œ)',
          data: cumActAway,
          borderWidth: 2,
          borderDash: [6,4],
          backgroundColor: 'rgba(255, 206, 86, 0.05)',
          borderColor: 'rgba(255, 206, 86, 0.7)',
          pointRadius: 2,
          hidden: hideCumActAway,
        },
        {
          label: '{{ home }} ì´ ë“ì  (ì‹¤ì œ)',
          data: cumActHome,
          borderWidth: 2,
          borderDash: [6,4],
          backgroundColor: 'rgba(75, 192, 192, 0.05)',
          borderColor: 'rgba(75, 192, 192, 0.7)',
          pointRadius: 2,
          hidden: hideCumActHome,
        },
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'nearest', intersect: false },
      scales: {
        y: { beginAtZero: true, ticks: { stepSize: 1 } }
      }
    }
  });
</script>

{% endblock %}