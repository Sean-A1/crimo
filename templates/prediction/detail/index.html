{% extends 'base.html' %}
{% load static %}
{% load static_league %}

{% block content %}


<!-- Í∑∏ÎûòÌîÑ -->
<!-- Prediction Ïï± Ï†ÑÏö© CSS -->
<link rel="stylesheet" href="{% static 'prediction/style.css' %}">

<div class="container my-4">

    <!-- Ï†úÎ™© -->
    <h2 class="mb-4"> Prediction detail Info</h2>

    <!-- Ïó∞ÎÖ∏ÎûëÏÉâ ÏóÖÎç∞Ïù¥Ìä∏ ÌòÑÌô© Î∞ïÏä§ -->
    <div class="alert alert-warning">
      üìå New Update : {{ date|date:"n" }}.{{ date|date:"j" }}.{{ date|date:"Y" }}
    </div>

    <!-- Ïó∞Ï¥àÎ°ùÏÉâ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î∞ïÏä§ -->
    <div class="alert alert-success">
      üìã <strong>Information</strong><br>
      üîπ Date : {{ date|date:"m/d" }}<br>
      <!-- StadiumÏùÄ ÏùºÏ†ï Î™®Îç∏ÏóêÏÑúÎßå ÏûàÏúºÎãà Ï†úÍ±∞ -->
      üîπ Prediction : {{ team1 }}({{ win_prob_team1|default:"-" }}%) vs {{ team2 }}({{ win_prob_team2|default:"-" }}%)<br>
    </div>
    

    <div class="row g-3 mb-3">
        <!-- Î∂ÑÎ•ò ÏÑ±Îä•ÏßÄÌëú -->
        <div class="col-12 col-lg-6">
            <div class="card h-100 border-info">
            <div class="card-header bg-info text-dark fw-bold">Classification Evaluation Metrics</div>
            <div class="card-body">
                <p class="mb-2 text-muted">You can check the data used for the latest predictions and the validation/test performance (Confusion Matrix, Report)</p>
                <a class="btn btn-outline-info"
                href="{% url 'prediction:class_metrics' league date_str away|upper home|upper %}">
                View used data, Confusion Matrix, Evaluation Metrics ‚Üí
                </a>
            </div>
            </div>
        </div>

        <!-- ÌöåÍ∑Ä ÏÉÅÏÑ∏ÏßÄÌëú -->
        <div class="col-12 col-lg-6">
            <div class="card h-100 border-info">
            <div class="card-header bg-info text-dark fw-bold">Regression Evaluation Metrics</div>
            <div class="card-body">
                <p class="mb-3 text-muted small">
                  Check detailed logs such as starting pitchers (actual/predicted), pitcher change logs, and game PKs
                </p>
                <a class="btn btn-outline-info"
                href="{% url 'prediction:reg_metrics' league date_str away|upper home|upper %}">
                View used data, detailed logs
                </a>
            </div>
            </div>
        </div>
    </div>



    <!-- Í∑∏ÎûòÌîÑ ÏÑπÏÖò -->
    <div class="card mt-4">

        <!-- ÎìùÏ†ê -->
        <div class="card-header bg-light">
            Scoring Scenario
        </div>

        <div class="card-body">
            <canvas id="scoreChart"></canvas>
        </div>

        <!-- Ï¥ù ÎìùÏ†ê -->
        <div class="card-header bg-light">
            Cumulative Scoring Scenario
        </div>

        <div class="card-body">
            <canvas id="cumulativeChart"></canvas>
        </div>

    </div>
</div>


<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const inning_labels = ['1st inn','2nd inn','3rd inn','4th inn','5th inn','6th inn','7th inn','8th inn','9th inn'];

  // Django Ïª®ÌÖçÏä§Ìä∏ÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞
  const predAway = {{ scenario_team1|safe }};   // away ÏòàÏ∏°
  const predHome = {{ scenario_team2|safe }};   // home ÏòàÏ∏°
  const actAway  = {{ actual_team1|safe }};     // away Ïã§Ï†ú (ÏóÜÏúºÎ©¥ [])
  const actHome  = {{ actual_team2|safe }};     // home Ïã§Ï†ú (ÏóÜÏúºÎ©¥ [])

  // ÎàÑÏ†Å ÏÉùÏÑ±(ÏóÜÎäî Îç∞Ïù¥ÌÑ∞Î©¥ Îπà Î∞∞Ïó¥Î°ú Î∞òÌôò)
  function cumulative(arr) {
    if (!Array.isArray(arr) || arr.length === 0) return [];
    const out = [];
    arr.reduce((acc, cur, idx) => {
      const v = (acc + (Number(cur) || 0));
      out.push(v);
      return v;
    }, 0);
    return out;
  }

  const cumPredAway = cumulative(predAway);
  const cumPredHome = cumulative(predHome);
  const cumActAway  = cumulative(actAway);
  const cumActHome  = cumulative(actHome);

  // Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ ÎùºÏù∏ Ïà®ÍπÄ
  const hideActAway = (actAway.length === 0);
  const hideActHome = (actHome.length === 0);
  const hideCumActAway = (cumActAway.length === 0);
  const hideCumActHome = (cumActHome.length === 0);

  // ‚úî ÎìùÏ†ê ÏãúÎÇòÎ¶¨Ïò§(Ïù¥ÎãùÎ≥Ñ) ‚Äî 4Í∞ú ÏÑ†
  const scoreCtx = document.getElementById('scoreChart').getContext('2d');
  new Chart(scoreCtx, {
    type: 'line',
    data: {
      labels: inning_labels,
      datasets: [
        {
          label: '{{ away }} (Pred)',
          data: predAway,
          borderWidth: 2,
          backgroundColor: 'rgba(255, 99, 132, 0.15)',
          borderColor: 'rgba(255, 99, 132, 1)',
          pointRadius: 2,
        },
        {
          label: '{{ home }} (Pred)',
          data: predHome,
          borderWidth: 2,
          backgroundColor: 'rgba(54, 162, 235, 0.15)',
          borderColor: 'rgba(54, 162, 235, 1)',
          pointRadius: 2,
        },
        {
          label: '{{ away }} (Final)',
          data: actAway,
          borderWidth: 2,
          borderDash: [6,4],
          backgroundColor: 'rgba(255, 99, 132, 0.05)',
          borderColor: 'rgba(255, 99, 132, 0.7)',
          pointRadius: 2,
          hidden: hideActAway,
        },
        {
          label: '{{ home }} (Final)',
          data: actHome,
          borderWidth: 2,
          borderDash: [6,4],
          backgroundColor: 'rgba(54, 162, 235, 0.05)',
          borderColor: 'rgba(54, 162, 235, 0.7)',
          pointRadius: 2,
          hidden: hideActHome,
        },
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'nearest', intersect: false },
      scales: {
        y: { beginAtZero: true, ticks: { stepSize: 1 } }
      }
    }
  });

  // ‚úî Ï¥ù ÎìùÏ†ê(ÎàÑÏ†Å) ‚Äî 4Í∞ú ÏÑ†
  const cumulativeCtx = document.getElementById('cumulativeChart').getContext('2d');
  new Chart(cumulativeCtx, {
    type: 'line',
    data: {
      labels: inning_labels,
      datasets: [
        {
          label: '{{ away }}-Cumul (Pred)',
          data: cumPredAway,
          borderWidth: 2,
          backgroundColor: 'rgba(255, 206, 86, 0.15)',
          borderColor: 'rgba(255, 206, 86, 1)',
          pointRadius: 2,
        },
        {
          label: '{{ home }}-Cumul (Pred)',
          data: cumPredHome,
          borderWidth: 2,
          backgroundColor: 'rgba(75, 192, 192, 0.15)',
          borderColor: 'rgba(75, 192, 192, 1)',
          pointRadius: 2,
        },
        {
          label: '{{ away }}-Cumul (Final)',
          data: cumActAway,
          borderWidth: 2,
          borderDash: [6,4],
          backgroundColor: 'rgba(255, 206, 86, 0.05)',
          borderColor: 'rgba(255, 206, 86, 0.7)',
          pointRadius: 2,
          hidden: hideCumActAway,
        },
        {
          label: '{{ home }}-Cumul (Final)',
          data: cumActHome,
          borderWidth: 2,
          borderDash: [6,4],
          backgroundColor: 'rgba(75, 192, 192, 0.05)',
          borderColor: 'rgba(75, 192, 192, 0.7)',
          pointRadius: 2,
          hidden: hideCumActHome,
        },
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'nearest', intersect: false },
      scales: {
        y: { beginAtZero: true, ticks: { stepSize: 1 } }
      }
    }
  });
</script>

{% endblock %}